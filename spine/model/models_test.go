package model

import (
	"encoding/json"
	"fmt"
	"testing"
)

func TestDiscoveryDecode(t *testing.T) {
	tests := []struct {
		name string
		json string
	}{
		{"Discovery", `{"datagram":[{"header":[{"specificationVersion":"1.2.0"},{"addressSource":[{"device":"d:_i:3210_HEMS"},{"entity":[0]},{"feature":0}]},{"addressDestination":[{"entity":[0]},{"feature":0}]},{"msgCounter":5876},{"cmdClassifier":"read"}]},{"payload":[{"cmd":[[{"nodeManagementDetailedDiscoveryData":[]}]]}]}]}`},
		{"Services1", `{"datagram":[{"header":[{"specificationVersion":"1.2.0"},{"addressSource":[{"device":"d:_i:3210_HEMS"},{"entity":[0]},{"feature":0}]},{"addressDestination":[{"device":"d:_i:19667_PorscheEVSE_0001503"},{"entity":[0]},{"feature":0}]},{"msgCounter":5881},{"msgCounterReference":1},{"cmdClassifier":"reply"}]},{"payload":[{"cmd":[[{"nodeManagementDetailedDiscoveryData":[{"specificationVersionList":[{"specificationVersion":["1.2.0"]}]},{"deviceInformation":[{"description":[{"deviceAddress":[{"device":"d:_i:3210_HEMS"}]},{"deviceType":"EnergyManagementSystem"},{"networkFeatureSet":"smart"}]}]},{"entityInformation":[[{"description":[{"entityAddress":[{"entity":[0]}]},{"entityType":"DeviceInformation"}]}],[{"description":[{"entityAddress":[{"entity":[1]}]},{"entityType":"CEM"},{"description":"CEM Energy Guard"}]}],[{"description":[{"entityAddress":[{"entity":[2]}]},{"entityType":"HeatPumpAppliance"},{"description":"CEM Controllable System"}]}]]},{"featureInformation":[[{"description":[{"featureAddress":[{"entity":[0]},{"feature":0}]},{"featureType":"NodeManagement"},{"role":"special"},{"supportedFunction":[[{"function":"nodeManagementDetailedDiscoveryData"},{"possibleOperations":[{"read":[]}]}],[{"function":"nodeManagementSubscriptionRequestCall"},{"possibleOperations":[]}],[{"function":"nodeManagementBindingRequestCall"},{"possibleOperations":[]}],[{"function":"nodeManagementSubscriptionDeleteCall"},{"possibleOperations":[]}],[{"function":"nodeManagementBindingDeleteCall"},{"possibleOperations":[]}],[{"function":"nodeManagementSubscriptionData"},{"possibleOperations":[{"read":[]}]}],[{"function":"nodeManagementBindingData"},{"possibleOperations":[{"read":[]}]}],[{"function":"nodeManagementUseCaseData"},{"possibleOperations":[{"read":[]}]}]]}]}],[{"description":[{"featureAddress":[{"entity":[0]},{"feature":1}]},{"featureType":"DeviceClassification"},{"role":"server"},{"supportedFunction":[[{"function":"deviceClassificationManufacturerData"},{"possibleOperations":[{"read":[]}]}]]}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":1}]},{"featureType":"DeviceClassification"},{"role":"client"},{"description":"Device Classification"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":2}]},{"featureType":"DeviceDiagnosis"},{"role":"client"},{"description":"Device Diagnosis"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":3}]},{"featureType":"Measurement"},{"role":"client"},{"description":"Measurement for client"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":4}]},{"featureType":"DeviceConfiguration"},{"role":"client"},{"description":"Device Configuration"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":5}]},{"featureType":"DeviceDiagnosis"},{"role":"server"},{"supportedFunction":[[{"function":"deviceDiagnosisStateData"},{"possibleOperations":[{"read":[]}]}],[{"function":"deviceDiagnosisHeartbeatData"},{"possibleOperations":[{"read":[]}]}]]},{"description":"DeviceDiag"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":7}]},{"featureType":"LoadControl"},{"role":"client"},{"description":"LoadControl client for CEM"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":8}]},{"featureType":"Identification"},{"role":"client"},{"description":"EV identification"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":9}]},{"featureType":"ElectricalConnection"},{"role":"client"},{"description":"Electrical Connection"}]}],[{"description":[{"featureAddress":[{"entity":[2]},{"feature":10}]},{"featureType":"LoadControl"},{"role":"server"},{"supportedFunction":[[{"function":"loadControlLimitDescriptionListData"},{"possibleOperations":[{"read":[]}]}],[{"function":"loadControlLimitListData"},{"possibleOperations":[{"read":[]},{"write":[]}]}]]},{"description":"Load Control"}]}],[{"description":[{"featureAddress":[{"entity":[2]},{"feature":11}]},{"featureType":"ElectricalConnection"},{"role":"server"},{"supportedFunction":[[{"function":"electricalConnectionCharacteristicListData"},{"possibleOperations":[{"read":[]}]}],[{"function":"electricalConnectionDescriptionListData"},{"possibleOperations":[{"read":[]}]}]]},{"description":"Electrical Connection"}]}],[{"description":[{"featureAddress":[{"entity":[2]},{"feature":12}]},{"featureType":"DeviceConfiguration"},{"role":"server"},{"supportedFunction":[[{"function":"deviceConfigurationKeyValueDescriptionListData"},{"possibleOperations":[{"read":[]}]}],[{"function":"deviceConfigurationKeyValueListData"},{"possibleOperations":[{"read":[]},{"write":[]}]}]]},{"description":"Device Configuration"}]}]]}]}]]}]}]}`},
		{"Services2", `{"datagram":[{"header":[{"specificationVersion":"1.1.1"},{"addressSource":[{"device":"d:_i:19667_PorscheEVSE-00016544"},{"entity":[0]},{"feature":0}]},{"addressDestination":[{"device":"d:_i:3210_HEMS"},{"entity":[0]},{"feature":0}]},{"msgCounter":98},{"msgCounterReference":5876},{"cmdClassifier":"reply"}]},{"payload":[{"cmd":[[{"nodeManagementDetailedDiscoveryData":[{"specificationVersionList":[{"specificationVersion":["1.1.1"]}]},{"deviceInformation":[{"description":[{"deviceAddress":[{"device":"d:_i:19667_PorscheEVSE-00016544"}]},{"deviceType":"ChargingStation"},{"networkFeatureSet":"smart"}]}]},{"entityInformation":[[{"description":[{"entityAddress":[{"entity":[0]}]},{"entityType":"DeviceInformation"}]}],[{"description":[{"entityAddress":[{"entity":[1]}]},{"entityType":"EVSE"},{"description":"Electric Vehicle Supply Equipment"}]}]]},{"featureInformation":[[{"description":[{"featureAddress":[{"entity":[0]},{"feature":0}]},{"featureType":"NodeManagement"},{"role":"special"},{"supportedFunction":[[{"function":"nodeManagementDetailedDiscoveryData"},{"possibleOperations":[{"read":[]}]}],[{"function":"nodeManagementSubscriptionRequestCall"},{"possibleOperations":[]}],[{"function":"nodeManagementBindingRequestCall"},{"possibleOperations":[]}],[{"function":"nodeManagementSubscriptionDeleteCall"},{"possibleOperations":[]}],[{"function":"nodeManagementBindingDeleteCall"},{"possibleOperations":[]}],[{"function":"nodeManagementSubscriptionData"},{"possibleOperations":[{"read":[]}]}],[{"function":"nodeManagementBindingData"},{"possibleOperations":[{"read":[]}]}],[{"function":"nodeManagementUseCaseData"},{"possibleOperations":[{"read":[]}]}]]}]}],[{"description":[{"featureAddress":[{"entity":[0]},{"feature":1}]},{"featureType":"DeviceClassification"},{"role":"server"},{"supportedFunction":[[{"function":"deviceClassificationManufacturerData"},{"possibleOperations":[{"read":[]}]}]]}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":1}]},{"featureType":"DeviceClassification"},{"role":"server"},{"supportedFunction":[[{"function":"deviceClassificationManufacturerData"},{"possibleOperations":[{"read":[]}]}]]},{"description":"Device Classification for EVSE"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":2}]},{"featureType":"DeviceDiagnosis"},{"role":"server"},{"supportedFunction":[[{"function":"deviceDiagnosisStateData"},{"possibleOperations":[{"read":[]}]}]]},{"description":"Device Diagnosis EVSE"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":3}]},{"featureType":"DeviceClassification"},{"role":"client"},{"description":"EMS Device Classification"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":5}]},{"featureType":"DeviceDiagnosis"},{"role":"client"},{"description":"Device Diagnosis Heartbeat"}]}],[{"description":[{"featureAddress":[{"entity":[1]},{"feature":6}]},{"featureType":"Bill"},{"role":"server"},{"supportedFunction":[[{"function":"billDescriptionListData"},{"possibleOperations":[{"read":[]}]}],[{"function":"billConstraintsListData"},{"possibleOperations":[{"read":[]}]}],[{"function":"billListData"},{"possibleOperations":[{"read":[]},{"write":[]}]}]]},{"description":"Bill Feature for EVSE"}]}]]}]}]]}]}]}`},
	}
	for _, tc := range tests {
		t.Run(tc.name, func(t *testing.T) {
			var res CmiDatagramType
			if err := json.Unmarshal([]byte(tc.json), &res); err != nil {
				t.Error(err)
			}

			cmd := res.Datagram.Payload.Cmd[0].NodeManagementDetailedDiscoveryData
			fmt.Printf("%+v\n", res.Datagram.Header)
			fmt.Printf("%+v\n", res.Datagram.Payload)
			fmt.Printf("%+v\n", cmd)

			if cmd.SpecificationVersionList != nil {
				fmt.Printf("SpecificationVersionList: %+v\n", cmd.SpecificationVersionList)
			}
			if cmd.DeviceInformation != nil {
				fmt.Printf("DeviceInformation: %+v\n", cmd.DeviceInformation)
			}
			if cmd.EntityInformation != nil {
				fmt.Printf("EntityInformation: %+v\n", cmd.EntityInformation)
			}
			if cmd.FeatureInformation != nil {
				fmt.Printf("FeatureInformation: %+v\n", cmd.FeatureInformation)
			}
		})
	}
}
